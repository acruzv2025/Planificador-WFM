{% extends "base.html" %}

{% block title %}Planificación de Horarios - Emergia{% endblock %}

{% block page_title %}Central de Planificación de Horarios{% endblock %}

{% block head_content %}
<style>
    /* --- INICIO DE ESTILOS MEJORADOS PARA LA PÁGINA DE PLANIFICACIÓN --- */

    /* Estilos generales de la página */
    .chart-container { position: relative; height: 40vh; max-height: 400px; margin-bottom: 2rem; }
    .section-card { margin-bottom: 2rem; } 

    /* --- Mejoras en la Tabla de Horarios --- */
    .schedule-table {
        border-collapse: separate; 
        border-spacing: 0;
        width: 100%;
    }

    /* Cabeceras y Celdas */
    .schedule-table th, .schedule-table td {
        padding: 10px 8px; 
        text-align: center;
        vertical-align: middle;
        border-bottom: 1px solid #dfe4ea;
        font-size: 0.85rem; 
        white-space: normal; 
        min-width: 120px;
    }

    .schedule-table th {
        background-color: #f0f2f5;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    
    /* Columna de Agente Fija (Sticky) */
    .schedule-table td:first-child, .schedule-table th:first-child {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: #ffffff; 
        text-align: left;
        font-weight: 500;
        min-width: 180px; 
        border-right: 1px solid #dfe4ea;
    }
    
    .schedule-table th:first-child {
        z-index: 3;
        background-color: #e9ecef;
    }

    /* Filas "Cebra" para facilitar la lectura horizontal */
    .schedule-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    .schedule-table tbody tr:nth-child(even) td:first-child {
        background-color: #f8f9fa;
    }
    .schedule-table tbody tr:hover {
        background-color: #eef5ff; 
    }
    .schedule-table tbody tr:hover td:first-child {
        background-color: #eef5ff;
    }

    /* --- Color-Coding para Tipos de Turno --- */
    .schedule-table td span {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
        width: 100%;
    }

    .shift-work span { 
        background-color: transparent; /* Turno de trabajo no necesita fondo */
    }
    .shift-libre span { 
        background-color: #f1f3f5;
        color: #868e96;
    }
    .shift-ausencia { 
        font-weight: bold;
    }
    .shift-ausencia span {
        color: #fff;
    }
    .shift-vac span { background-color: #3498db; }    /* Azul para Vacaciones */
    .shift-bmed span { background-color: #e74c3c; }   /* Rojo para Baja Médica */
    .shift-fest span { background-color: #2ecc71; }   /* Verde para Festivo */
    .shift-otro span { background-color: #9b59b6; }   /* Morado para otros */
    
    /* Celda editada manualmente */
    .schedule-table td.manual-edit {
        border-left: 3px solid var(--color-emergia-magenta);
    }

    /* Estilo del input al editar */
    .schedule-table input {
        width: 100%;
        padding: 5px;
        border: 2px solid var(--color-emergia-magenta);
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.85rem;
        text-align: center;
        box-shadow: 0 0 5px rgba(136, 0, 227, 0.3);
    }
    /* --- FIN DE ESTILOS MEJORADOS --- */
</style>
{% endblock %}

{% block content %}
<div id="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}" style="display: block; margin-bottom: 1rem;">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<div class="section-card">
    <h2>Paso 1: Cargar Plantillas</h2>
    <div class="form-grid">
        <div class="form-group">
            <label for="agents_excel">Plantilla de Agentes (.xlsx)</label>
            <input type="file" id="agents_excel" accept=".xlsx">
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                <button type="button" id="upload-btn" style="flex: 1;">Cargar</button>
            </div>
            <div class="loader" id="upload-loader" style="margin-top: 0.5rem;"></div>
            <div id="upload-feedback"></div>
        </div>
        <div class="form-group">
            <label for="ausencias_excel">Plantilla de Ausencias (España) (.xlsx)</label>
            <input type="file" id="ausencias_excel" accept=".xlsx">
            <button type="button" id="upload-ausencias-btn" style="margin-top: 0.5rem;">Cargar Ausencias</button>
            <div class="loader" id="ausencias-loader" style="margin-top: 0.5rem;"></div>
            <div id="ausencias-feedback"></div>
        </div>
    </div>
</div>

<div class="section-card">
    <h2>Paso 2: Generar o Consultar Horarios</h2>
    <form id="schedule-form" class="form-grid">
        <div class="form-group">
            <label for="segment_id">Servicio (Segmento)</label>
            <select id="segment_id" required>
                {% for segment in segments %}
                    <option value="{{ segment.id }}">{{ segment.campaign.name }} - {{ segment.name }}</option>
                {% else %}
                    <option value="" disabled>No tienes permisos para ninguna campaña/segmento.</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group"><label for="start_date">Fecha de Inicio</label><input type="date" id="start_date" required></div>
        <div class="form-group"><label for="end_date">Fecha de Fin</label><input type="date" id="end_date" required></div>
        <div class="form-group" style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
            <button type="button" id="fetch-btn" style="background-color: #27ae60;">Consultar Horarios</button>
            <button type="button" id="fill-gaps-btn" style="background-color: #3498db;">Asignar Personal Nuevo</button>
            <button type="button" id="export-btn" style="background-color: #16a085;">Exportar a Excel</button>
            <button type="button" id="generate-btn">Generar Nuevos Horarios</button>
        </div>
    </form>
    <div class="loader" id="schedule-loader"></div><div id="schedule-feedback"></div>
</div>

<div id="schedule-results-container" style="display: none;">
    <div class="section-card">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2>Gráfico de Cobertura</h2>
            <div class="form-group" style="min-width: 250px;">
                <label for="chart-day-selector">Seleccionar Día</label>
                <select id="chart-day-selector"></select>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="coverageChart"></canvas>
        </div>
    </div>
    <div class="section-card">
        <h2>Tabla de Horarios</h2>
        <div id="schedule-table-container" class="table-wrapper"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const VALID_AUSENCIA_CODES = ["VAC", "BMED", "LICMATER", "LICPATER", "LACT", "FEST", "ACC", "ENF", "ENFHOSP", "SIT-ESP", "OTRO"];
    
    const uploadBtn = document.getElementById('upload-btn');
    const uploadLoader = document.getElementById('upload-loader');
    const uploadFeedbackDiv = document.getElementById('upload-feedback');
    const fileInput = document.getElementById('agents_excel');
    const uploadAusenciasBtn = document.getElementById('upload-ausencias-btn');
    const ausenciasLoader = document.getElementById('ausencias-loader');
    const ausenciasFeedback = document.getElementById('ausencias-feedback');
    const ausenciasFileInput = document.getElementById('ausencias_excel');

    async function handleAgentUpload(url) {
        if (fileInput.files.length === 0) {
            uploadFeedbackDiv.innerHTML = `<div class="alert alert-error">Por favor, seleccione un archivo.</div>`;
            return;
        }
        uploadBtn.disabled = true; 
        uploadLoader.style.display = 'block'; uploadFeedbackDiv.innerHTML = '';
        const formData = new FormData();
        formData.append('agents_excel', fileInput.files[0]);
        try {
            const response = await fetch(url, { method: 'POST', body: formData });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.error || `Error ${response.status}`); }
            uploadFeedbackDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        } catch (error) {
            uploadFeedbackDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
        } finally {
            uploadBtn.disabled = false;
            uploadLoader.style.display = 'none'; fileInput.value = '';
        }
    }
    uploadBtn.addEventListener('click', () => handleAgentUpload("{{ url_for('upload_agents') }}"));

    async function handleAusenciaUpload() {
        if (ausenciasFileInput.files.length === 0) {
            ausenciasFeedback.innerHTML = `<div class="alert alert-error">Por favor, seleccione un archivo de ausencias.</div>`; return;
        }
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        if (!startDate || !endDate) {
            ausenciasFeedback.innerHTML = `<div class="alert alert-error">Por favor, seleccione un rango de fechas en el Paso 2 antes de cargar ausencias.</div>`;
            return;
        }
        uploadAusenciasBtn.disabled = true;
        ausenciasLoader.style.display = 'block'; ausenciasFeedback.innerHTML = '';
        const formData = new FormData();
        formData.append('ausencias_excel', ausenciasFileInput.files[0]);
        formData.append('start_date', startDate);
        formData.append('end_date', endDate);
        try {
            const response = await fetch("{{ url_for('upload_ausencias') }}", { method: 'POST', body: formData });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.error || `Error ${response.status}`); }
            ausenciasFeedback.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        } catch (error) {
            ausenciasFeedback.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
        } finally {
            uploadAusenciasBtn.disabled = false;
            ausenciasLoader.style.display = 'none'; ausenciasFileInput.value = '';
        }
    }
    uploadAusenciasBtn.addEventListener('click', handleAusenciaUpload);

    const scheduleForm = document.getElementById('schedule-form');
    const generateBtn = document.getElementById('generate-btn');
    const fetchBtn = document.getElementById('fetch-btn');
    const fillGapsBtn = document.getElementById('fill-gaps-btn');
    const scheduleLoader = document.getElementById('schedule-loader');
    const scheduleFeedback = document.getElementById('schedule-feedback');
    const resultsContainer = document.getElementById('schedule-results-container');
    const tableContainer = document.getElementById('schedule-table-container');
    const chartCanvas = document.getElementById('coverageChart');
    const daySelector = document.getElementById('chart-day-selector');
    let coverageChart = null;
    let chartDataStore = {};
    let agentIdMap = {};

    fetchBtn.addEventListener('click', () => fetchAndDisplaySchedule("{{ url_for('get_schedule') }}"));

    fillGapsBtn.addEventListener('click', () => {
        if (confirm("Esto asignará horarios al personal nuevo o sin planificar sin alterar los horarios existentes. ¿Desea continuar?")) {
            fetchAndDisplaySchedule("{{ url_for('fill_gaps_schedule') }}");
        }
    });
    
    generateBtn.addEventListener('click', () => {
         if (confirm("¡Atención! Esto borrará y regenerará TODOS los horarios para el rango de fechas seleccionado (excepto ausencias). ¿Estás seguro?")) {
            fetchAndDisplaySchedule("{{ url_for('generate_schedule') }}");
        }
    });

    async function fetchAndDisplaySchedule(url) {
        const allButtons = [generateBtn, fetchBtn, fillGapsBtn, document.getElementById('export-btn')];
        allButtons.forEach(btn => btn.disabled = true);
        scheduleLoader.style.display = 'block'; scheduleFeedback.innerHTML = ''; resultsContainer.style.display = 'none';
        
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        if (!startDate || !endDate) {
            scheduleFeedback.innerHTML = `<div class="alert alert-error">Por favor, seleccione una fecha de inicio y fin.</div>`;
            allButtons.forEach(btn => btn.disabled = false); scheduleLoader.style.display = 'none';
            return;
        }
        try {
            const response = await fetch(url, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ segment_id: document.getElementById('segment_id').value, start_date: startDate, end_date: endDate })
            });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.error || `Error ${response.status}`); }
            agentIdMap = result.agent_map || {};
            chartDataStore = result.chart_data;
            renderScheduleTable(result.schedule);
            renderCoverageChart();
            resultsContainer.style.display = 'block';
            
            if (result.flash_message) {
                 const flashContainer = document.getElementById('flash-container');
                 flashContainer.innerHTML = `<div class="alert alert-success" style="display: block; margin-bottom: 1rem;">${result.flash_message}</div>`;
            }
        } catch (error) {
            scheduleFeedback.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
        } finally {
            allButtons.forEach(btn => btn.disabled = false);
            scheduleLoader.style.display = 'none';
        }
    }

    /**
     * Función de ayuda para obtener la clase CSS correcta según el contenido del turno.
     */
    function getShiftClass(shift) {
        if (shift === 'LIBRE') return 'shift-libre';
        
        if (VALID_AUSENCIA_CODES.includes(shift)) {
            switch(shift) {
                case 'VAC': return 'shift-ausencia shift-vac';
                case 'BMED': return 'shift-ausencia shift-bmed';
                case 'FEST': return 'shift-ausencia shift-fest';
                default: return 'shift-ausencia shift-otro';
            }
        }
        if (shift.includes('-')) return 'shift-work';
        return '';
    }

    /**
     * Versión MODIFICADA de la función para renderizar la tabla con las mejoras visuales.
     */
    function renderScheduleTable(scheduleData) {
        if (!scheduleData || Object.keys(scheduleData).length === 0) {
            tableContainer.innerHTML = "<p>No hay datos de horario para mostrar.</p>"; return;
        }
        const agents = Object.keys(scheduleData).sort();
        const allKeys = new Set();
        agents.forEach(agent => Object.keys(scheduleData[agent]).forEach(key => allKeys.add(key)));
        const dateKeys = Array.from(allKeys).filter(key => !key.startsWith('week_') && !key.endsWith('_manual')).sort();
        const weeklyColumns = {};
        dateKeys.forEach(key => {
            const dateObj = new Date(key + 'T00:00:00');
            const weekNum = getISOWeek(dateObj);
            if (!weeklyColumns[weekNum]) weeklyColumns[weekNum] = { dates: [] };
            weeklyColumns[weekNum].dates.push(key);
        });
        let tableHTML = '<table class="schedule-table"><thead><tr><th>Agente</th>';
        const sortedWeeks = Object.keys(weeklyColumns).sort((a, b) => a - b);
        sortedWeeks.forEach(weekNum => {
            const week = weeklyColumns[weekNum];
            week.dates.sort().forEach(date => tableHTML += `<th>${new Date(date + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'short', day: '2-digit', month: '2-digit'})}</th>`);
            if (allKeys.has(`week_${weekNum}_total`)) {
                 tableHTML += `<th style="background-color: #e0e0e0;">Horas Sem ${weekNum}</th>`;
            }
        });
        tableHTML += '</tr></thead><tbody>';
        agents.forEach(agent => {
            const agentId = agentIdMap[agent];
            tableHTML += `<tr><td class="agent-name">${agent}</td>`;
            sortedWeeks.forEach(weekNum => {
                const week = weeklyColumns[weekNum];
                week.dates.forEach(date => {
                    const shift = scheduleData[agent][date] || 'LIBRE';
                    const isManual = scheduleData[agent][`${date}_manual`] || false;
                    const manualClass = isManual ? 'manual-edit' : '';
                    const shiftClass = getShiftClass(shift); 
                    
                    tableHTML += `<td class="editable ${manualClass} ${shiftClass}" data-agent-id="${agentId}" data-date="${date}" data-original-is-manual="${isManual}" onclick="editCell(this)"><span>${shift}</span></td>`;
                });
                if (allKeys.has(`week_${weekNum}_total`)) {
                    const totalHours = scheduleData[agent][`week_${weekNum}_total`] || 0;
                    tableHTML += `<td data-week-total="${weekNum}" style="background-color: #f5f5f5;"><strong>${Number(totalHours).toFixed(2)}</strong></td>`;
                }
            });
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    }
    
    function editCell(cell) {
        if (cell.querySelector('input')) return;
        const currentShift = cell.querySelector('span').innerText;
        const agentId = cell.dataset.agentId;
        const date = cell.dataset.date;
        if (!agentId) { console.error("Agent ID no encontrado para la celda:", cell); return; }
        cell.innerHTML = `<input type="text" value="${currentShift}" onblur="saveEdit(this, '${agentId}', '${date}')" onkeydown="handleKeydown(event, this, '${agentId}', '${date}')" />`;
        cell.querySelector('input').focus();
    }

    function handleKeydown(event, inputElement, agentId, date) {
        if (event.key === 'Enter') inputElement.blur();
        else if (event.key === 'Escape') {
            const originalShift = inputElement.defaultValue;
            const cell = inputElement.parentElement;
            cell.innerHTML = `<span>${originalShift}</span>`;
            if (cell.dataset.originalIsManual === 'true') { cell.classList.add('manual-edit'); } 
            else { cell.classList.remove('manual-edit'); }
        }
    }

    async function saveEdit(inputElement, agentId, date) {
        const newShift = inputElement.value.trim().toUpperCase();
        const cell = inputElement.parentElement;
        const originalShift = inputElement.defaultValue;
        const isShiftFormat = /^\d{2}:\d{2}-\d{2}:\d{2}(\/\d{2}:\d{2}-\d{2}:\d{2})*$/.test(newShift);
        const isAusencia = VALID_AUSENCIA_CODES.includes(newShift);
        const isLibre = newShift === 'LIBRE';
        if (!isShiftFormat && !isAusencia && !isLibre) {
            alert("Formato inválido. Use HH:MM-HH:MM o un código de ausencia válido (ej. VAC, BMED).");
            cell.innerHTML = `<span>${originalShift}</span>`; return;
        }
        if (newShift === originalShift) { cell.innerHTML = `<span>${originalShift}</span>`; return; }
        cell.innerHTML = `<span>Guardando...</span>`;
        try {
            const response = await fetch("{{ url_for('update_schedule') }}", {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ agent_id: agentId, date: date, shift: newShift })
            });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.error); }
            cell.innerHTML = `<span>${newShift}</span>`;
            cell.classList.add('manual-edit');
            cell.dataset.originalIsManual = 'true';
            
            // Actualizar clase de color
            cell.className = `editable manual-edit ${getShiftClass(newShift)}`;

            updateWeeklyTotal(cell, result.new_weekly_total);
            updateCoverageDataForDay(date);
        } catch (error) {
            alert(`Error al guardar: ${error.message}`);
            cell.innerHTML = `<span>${originalShift}</span>`;
        }
    }

    function updateWeeklyTotal(cell, newTotal) {
        const row = cell.parentElement;
        const weekNumber = getISOWeek(new Date(cell.dataset.date + 'T00:00:00'));
        const weekTotalCell = row.querySelector(`[data-week-total="${weekNumber}"]`);
        if(weekTotalCell){
            weekTotalCell.innerHTML = `<strong>${newTotal.toFixed(2)}</strong>`;
        }
    }

    function updateCoverageDataForDay(dateStr) {
        if (!chartDataStore.labels || !chartDataStore.days[dateStr]) return;
        const newCoverage = new Array(chartDataStore.labels.length).fill(0);
        const allCellsForDay = document.querySelectorAll(`td[data-date="${dateStr}"]`);
        allCellsForDay.forEach(cell => {
            const shift = cell.querySelector('span').innerText;
            if (shift && shift !== 'LIBRE' && !VALID_AUSENCIA_CODES.includes(shift) && shift.includes('-')) {
                const parts = shift.split('/');
                parts.forEach(part => {
                    const [startStr, endStr] = part.split('-');
                    if(startStr && endStr) {
                        const startIndex = chartDataStore.labels.indexOf(startStr.trim());
                        const endIndex = chartDataStore.labels.indexOf(endStr.trim());
                        if (startIndex !== -1 && endIndex !== -1) {
                            for (let i = startIndex; i < endIndex; i++) { newCoverage[i]++; }
                        }
                    }
                });
            }
        });
        chartDataStore.days[dateStr].coverage = newCoverage;
        if(daySelector.value === dateStr || daySelector.value === 'average'){
            renderCoverageChart(daySelector.value);
        }
    }

    function getISOWeek(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        return String(weekNo);
    }

    function renderCoverageChart(dayToDisplay = null) {
        daySelector.innerHTML = '';
        if (!chartDataStore || !chartDataStore.days || Object.keys(chartDataStore.days).length === 0) {
            if (coverageChart) coverageChart.destroy();
            return;
        }
        const sortedDays = Object.keys(chartDataStore.days).sort();
        const avgOption = document.createElement('option');
        avgOption.value = 'average'; avgOption.textContent = 'Promedio del Periodo';
        daySelector.appendChild(avgOption);
        sortedDays.forEach(day => {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = new Date(day + 'T00:00:00').toLocaleDateString('es-ES', { dateStyle: 'full' });
            daySelector.appendChild(option);
        });
        daySelector.value = dayToDisplay || 'average';
        daySelector.onchange = () => renderCoverageChart(daySelector.value);
        let needData, coverageData, title;
        const displayValue = daySelector.value;
        if (displayValue === 'average') {
            const numDays = Object.keys(chartDataStore.days).length;
            if (numDays > 0) {
                const numLabels = chartDataStore.labels.length;
                needData = new Array(numLabels).fill(0);
                coverageData = new Array(numLabels).fill(0);
                for(const day of Object.values(chartDataStore.days)) {
                    for(let i = 0; i < numLabels; i++) {
                        needData[i] += day.need[i];
                        coverageData[i] += day.coverage[i];
                    }
                }
                needData = needData.map(n => n / numDays);
                coverageData = coverageData.map(c => c / numDays);
            } else {
                needData = []; coverageData = [];
            }
            title = 'Cobertura Promedio del Periodo';
        } else {
            const dayData = chartDataStore.days[displayValue];
            needData = dayData.need; coverageData = dayData.coverage;
            title = `Cobertura para ${new Date(displayValue + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}`;
        }
        if (coverageChart) { coverageChart.destroy(); }
        coverageChart = new Chart(chartCanvas, {
            type: 'line',
            data: {
                labels: chartDataStore.labels,
                datasets: [
                    { label: "Necesidad", data: needData, borderColor: "#3498db", backgroundColor: "rgba(52, 152, 219, 0.1)", fill: false, tension: 0.1, pointRadius: 1 },
                    { label: "Cobertura", data: coverageData, borderColor: "#27ae60", backgroundColor: "rgba(39, 174, 96, 0.1)", fill: false, tension: 0.1, pointRadius: 1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { title: { display: true, text: title, font: { size: 16 } } },
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Nº de Agentes' } }, x: { title: { display: true, text: 'Intervalo del Día' } } }
            }
        });
    }

    const exportBtn = document.getElementById('export-btn');
    exportBtn.addEventListener('click', async () => {
        exportBtn.disabled = true;
        exportBtn.textContent = 'Exportando...';
        
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const segmentId = document.getElementById('segment_id').value;

        if (!startDate || !endDate || !segmentId) {
            alert("Por favor, seleccione un servicio y un rango de fechas para exportar.");
            exportBtn.disabled = false;
            exportBtn.textContent = 'Exportar a Excel';
            return;
        }

        try {
            const response = await fetch("{{ url_for('export_schedule') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ segment_id: segmentId, start_date: startDate, end_date: endDate })
            });

            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.error || `Error ${response.status}`);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            const disposition = response.headers.get('Content-Disposition');
            let filename = `Horarios_${startDate}_a_${endDate}.xlsx`;
            if (disposition && disposition.indexOf('attachment') !== -1) {
                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                const matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
            }
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);

        } catch (error) {
            alert(`Error al exportar: ${error.message}`);
        } finally {
            exportBtn.disabled = false;
            exportBtn.textContent = 'Exportar a Excel';
        }
    });
</script>
{% endblock %}