{% extends "base.html" %}

{% block title %}Previsión Intradía - Emergia{% endblock %}

{% block page_title %}Módulo de Previsión Intradía{% endblock %}

{% block head_content %}
<style>
    /* Estilos específicos para la página de Previsión Intradía */
    .section-card {
        background-color: #ffffff;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .section-card h2 {
        font-size: 1.3rem;
        margin-top: 0;
    }
    .loader {
        display: none; margin: 2rem auto; width: 48px; height: 48px;
        border: 5px solid rgba(0,0,0,0.1); border-top-color: var(--color-emergia-magenta);
        border-radius: 50%; animation: rotation 1s linear infinite;
    }
    @keyframes rotation { 100% { transform: rotate(360deg); } }

    #weekly-analysis-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
    }
    .week-card {
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1rem;
        background: #fff;
    }
    .week-card h3 { font-size: 1.1rem; margin-bottom: 1rem; }
    .weight-input-group { display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; }
    .weight-input { width: 80px !important; text-align: center; }
    .total-weight { font-weight: bold; font-size: 1.2rem; }
    .total-weight.invalid { color: var(--color-error); }

    #saved-curves-summary ul { list-style: none; padding-left: 0; }
    #saved-curves-summary li {
        background: #e9ecef;
        padding: 5px 10px;
        border-radius: 5px;
        margin-bottom: 5px;
        display: inline-block;
        margin-right: 5px;
    }
</style>
{% endblock %}


{% block content %}
<div id="alert-container"></div>

<!-- ======================= PASO 1 ======================= -->
<div class="section-card">
    <h2>Paso 1: Cargar Histórico y Analizar</h2>
    <p style="margin-top: 0.5rem; color: var(--color-light-text);">Sube un archivo Excel con el histórico. El sistema propondrá pesos para las últimas 6 semanas.</p>
    <div class="form-group" style="max-width: 500px; margin-top: 1.5rem;">
        <label for="historical_excel">Archivo Excel Histórico:</label>
        <input type="file" class="form-control-file" id="historical_excel" accept=".xlsx, .xls" required>
    </div>
    <button type="button" id="analyze-btn" class="btn btn-primary" style="max-width: 250px; margin-top: 1rem;">Analizar Histórico</button>
</div>

<!-- Contenedor principal que aparece tras el análisis -->
<div id="results-container" style="display: none;">
    <!-- ======================= PASO 2 ======================= -->
    <div class="section-card">
        <h2>Paso 2: Ponderación y Generación de Curvas</h2>
        <div class="form-group" style="max-width: 400px;">
            <label for="day-of-week-selector">Seleccionar día para modelar:</label>
            <select id="day-of-week-selector" class="form-control"></select>
        </div>
        <div id="weekly-analysis-container"></div>
        <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap">
            <button type="button" id="calculate-weighted-btn" class="btn btn-info">Calcular Curva Ponderada</button>
            <div>
                <span class="mr-2">Suma de Pesos:</span>
                <span id="total-weight" class="total-weight">0%</span>
            </div>
        </div>
    </div>

    <div id="final-curve-container" class="section-card" style="display: none;">
        <h2>Curva Ponderada Final</h2>
         <div style="position: relative; height: 50vh; min-height: 400px;">
            <canvas id="finalCurveChart"></canvas>
        </div>
        <button type="button" id="save-curve-btn" class="btn btn-success mt-3">Guardar Curva para este Día</button>
    </div>

    <!-- ======================= PASO 3 (Final) ======================= -->
    <div class="section-card">
        <h2>Paso 3: Guardar Pronóstico en el Sistema</h2>
        <p>Una vez guardadas las curvas, sube el archivo con la volumetría y selecciona el segmento para almacenar el pronóstico. Este quedará disponible para ser usado en la Calculadora.</p>
        
        <div id="saved-curves-summary">
            <strong>Curvas guardadas:</strong>
            <ul id="saved-curves-list">
                <li id="no-curves-msg">Ninguna</li>
            </ul>
        </div>
    
        <!-- Selector de Segmento -->
        <div class="form-group" style="max-width: 500px; margin-top: 1.5rem;">
            <label for="segment-selector-save"><strong>Seleccionar Segmento:</strong></label>
            <select id="segment-selector-save" class="form-control" required>
                <option value="" disabled selected>-- Elige un segmento --</option>
                {% for segment in segments %}
                <option value="{{ segment.id }}">{{ segment.campaign.name }} - {{ segment.name }}</option>
                {% endfor %}
            </select>
        </div>
    
        <!-- Input para el archivo de volumen -->
        <div class="form-group" style="max-width: 500px; margin-top: 1rem;">
            <label for="forecast_excel">Archivo Excel con Volumetría:</label>
            <input type="file" class="form-control-file" id="forecast_excel" accept=".xlsx, .xls" required>
        </div>
        
        <!-- Botón de Guardado Final -->
        <button type="button" id="save-forecast-btn" class="btn btn-success" style="margin-top: 1rem;">
            <i class="fas fa-save mr-2"></i>Guardar Pronóstico en el Sistema
        </button>
    </div>
</div>

<div class="loader" id="loader"></div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        Chart.register(ChartDataLabels);
    } catch (e) { console.error("Error al registrar el plugin de Chart.js:", e); }

    // --- Selectores ---
    const analyzeBtn = document.getElementById('analyze-btn');
    const daySelector = document.getElementById('day-of-week-selector');
    const analysisContainer = document.getElementById('weekly-analysis-container');
    const calculateWeightedBtn = document.getElementById('calculate-weighted-btn');
    const totalWeightSpan = document.getElementById('total-weight');
    const finalCurveContainer = document.getElementById('final-curve-container');
    const saveCurveBtn = document.getElementById('save-curve-btn');
    const savedCurvesList = document.getElementById('saved-curves-list');
    const noCurvesMsg = document.getElementById('no-curves-msg');
    const resultsContainer = document.getElementById('results-container');
    const loader = document.getElementById('loader');
    const alertContainer = document.getElementById('alert-container');
    const saveForecastBtn = document.getElementById('save-forecast-btn'); 

    // --- Estado Global ---
    let weeklyCharts = [];
    let finalCurveChart = null;
    let analysisData = null;
    let currentFinalCurve = null;
    let savedCurves = {};
    const dayMapping = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];

    // --- Funciones de UI ---
    function showAlert(message, type = 'danger') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `${message}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>`;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
    }

    function toggleLoading(isLoading) {
        if (loader) loader.style.display = isLoading ? 'block' : 'none';
        document.querySelectorAll('button').forEach(button => button.disabled = isLoading);
    }
    
    // --- Lógica de Pasos 1 y 2 ---
    function handleAnalyze() {
        const fileInput = document.getElementById('historical_excel');
        if (!fileInput || fileInput.files.length === 0) { showAlert('Por favor, seleccione un archivo Excel.'); return; }
        
        toggleLoading(true);
        resultsContainer.style.display = 'none';
        finalCurveContainer.style.display = 'none';
        savedCurves = {};
        updateSavedCurvesSummary();
        alertContainer.innerHTML = '';

        const formData = new FormData();
        formData.append('historical_data', fileInput.files[0]);

        fetch("{{ url_for('calculate_intraday_distribution') }}", { method: 'POST', body: formData })
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.error) }))
            .then(data => {
                showAlert('Análisis completado. Por favor, seleccione un día para modelar.', 'success');
                analysisData = data;
                populateDaySelector();
                displayWeeklyAnalysis(); 
                resultsContainer.style.display = 'block';
            })
            .catch(err => showAlert(err.message, 'danger'))
            .finally(() => toggleLoading(false));
    }

    function displayWeeklyAnalysis() {
        if (!analysisData) return;
        weeklyCharts.forEach(chart => chart.destroy());
        weeklyCharts = [];
        analysisContainer.innerHTML = '';
        finalCurveContainer.style.display = 'none';
        const selectedDay = daySelector.value;
        const dataForDay = (analysisData.weekly_data[selectedDay] || []).sort((a,b) => b.week - a.week);
        if (dataForDay.length === 0) {
            analysisContainer.innerHTML = `<p class="text-muted">No se encontraron datos para el día seleccionado.</p>`;
            updateTotalWeight();
            return;
        }
        dataForDay.forEach(week => {
            const card = document.createElement('div');
            card.className = 'week-card';
            const chartTitle = `Semana ${week.week} (${week.date}) - ${week.total_calls.toFixed(0)} llamadas`;
            const isOutlierClass = week.is_outlier ? 'text-danger font-weight-bold' : '';
            card.innerHTML = `<h3>${chartTitle}</h3><div style="height: 250px;"><canvas id="chart-week-${week.week}"></canvas></div><div class="weight-input-group"><label for="weight-week-${week.week}">Peso propuesto: </label><input type="number" id="weight-week-${week.week}" class="form-control weight-input" value="${week.proposed_weight}" min="0" max="100" data-week-id="${week.week}"><span>%</span><span class="ml-auto ${isOutlierClass}">${week.is_outlier ? 'ATÍPICO' : ''}</span></div>`;
            analysisContainer.appendChild(card);
        });
        dataForDay.forEach(week => {
            const canvas = document.getElementById(`chart-week-${week.week}`);
            const weeklyDistData = analysisData.labels.map(l => (week.intraday_dist[l] || 0) * 100);
            weeklyCharts.push(new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: analysisData.labels, datasets: [{ label: `Distribución`, data: weeklyDistData, borderColor: week.is_outlier ? '#e74c3c' : '#3498db', fill: false, tension: 0.1, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } } } }));
        });
        document.querySelectorAll('.weight-input').forEach(input => input.addEventListener('input', updateTotalWeight));
        updateTotalWeight();
    }

    function updateTotalWeight() {
        let total = 0;
        document.querySelectorAll('.weight-input').forEach(input => { total += Number(input.value) || 0; });
        totalWeightSpan.textContent = `${total}%`;
        totalWeightSpan.className = `total-weight ${Math.round(total) !== 100 ? 'invalid' : ''}`;
    }

    function handleCalculateWeightedCurve() {
        const weights = {};
        let total = 0;
        document.querySelectorAll('.weight-input').forEach(input => {
            weights[input.dataset.weekId] = Number(input.value) || 0;
            total += weights[input.dataset.weekId];
        });
        if (Math.round(total) !== 100) { showAlert('La suma de los pesos debe ser exactamente 100%.', 'warning'); return; }
        toggleLoading(true);
        fetch("{{ url_for('build_weighted_curve') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ weights: weights, day_of_week: daySelector.value, all_weekly_data: analysisData.weekly_data, labels: analysisData.labels }) })
            .then(res => res.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                currentFinalCurve = data.final_curve;
                renderFinalCurveChart(currentFinalCurve, analysisData.labels);
                finalCurveContainer.style.display = 'block';
                showAlert('Curva ponderada calculada con éxito.', 'success');
            })
            .catch(err => showAlert(err.message, 'danger'))
            .finally(() => toggleLoading(false));
    }

    function renderFinalCurveChart(curveData, labels) {
        const ctx = document.getElementById('finalCurveChart').getContext('2d');
        if (finalCurveChart) finalCurveChart.destroy();
        finalCurveChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: `Curva Ponderada para ${dayMapping[daySelector.value]}`, data: labels.map(l => (curveData[l] || 0) * 100), borderColor: '#2ecc71', fill: true, tension: 0.2, backgroundColor: 'rgba(46, 204, 113, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } }, scales: { y: { ticks: { callback: v => v.toFixed(2) + '%' } } } } });
    }
    
    function populateDaySelector() {
        daySelector.innerHTML = '';
        dayMapping.forEach((day, index) => {
            if (analysisData && analysisData.weekly_data[index] && analysisData.weekly_data[index].length > 0) {
                daySelector.add(new Option(day, index));
            }
        });
        if(daySelector.options.length > 0) daySelector.value = daySelector.options[0].value;
    }

    function handleSaveCurve() {
        if (!currentFinalCurve) { showAlert('Primero debe calcular una curva ponderada.', 'warning'); return; }
        const dayIndex = daySelector.value;
        savedCurves[dayIndex] = currentFinalCurve;
        updateSavedCurvesSummary();
        showAlert(`Curva para ${dayMapping[dayIndex]} guardada.`, 'success');
    }

    function updateSavedCurvesSummary() {
        savedCurvesList.innerHTML = '';
        const savedDays = Object.keys(savedCurves).sort();
        if (savedDays.length > 0) {
            noCurvesMsg.style.display = 'none';
            savedDays.forEach(dayIndex => {
                const li = document.createElement('li');
                li.textContent = dayMapping[dayIndex];
                savedCurvesList.appendChild(li);
            });
        } else {
            noCurvesMsg.style.display = 'inline-block';
        }
    }
    
    // --- Lógica para el Paso 3: Guardar en BD ---
    function handleSaveForecastToDB() {
        const forecastFileInput = document.getElementById('forecast_excel');
        const segmentSelector = document.getElementById('segment-selector-save');

        if (Object.keys(savedCurves).length === 0) { showAlert('Debe guardar al menos una curva ponderada.', 'warning'); return; }
        if (!segmentSelector || segmentSelector.value === "") { showAlert('Por favor, seleccione un segmento para guardar el pronóstico.', 'warning'); return; }
        if (!forecastFileInput || forecastFileInput.files.length === 0) { showAlert('Por favor, seleccione un archivo con la volumetría.', 'warning'); return; }

        toggleLoading(true);
        alertContainer.innerHTML = '';
        
        const formData = new FormData();
        formData.append('forecast_file', forecastFileInput.files[0]);
        formData.append('segment_id', segmentSelector.value);
        formData.append('curves_data', JSON.stringify({ curves: savedCurves, labels: analysisData.labels }));
        
        fetch("{{ url_for('save_forecast_to_db') }}", { method: 'POST', body: formData })
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.error) }))
            .then(data => {
                showAlert(data.message, 'success');
                forecastFileInput.value = ''; // Limpiar campos
                segmentSelector.value = '';
            })
            .catch(err => showAlert(err.message, 'danger'))
            .finally(() => toggleLoading(false));
    }

    // --- Asignación de Eventos ---
    analyzeBtn.addEventListener('click', handleAnalyze);
    daySelector.addEventListener('change', displayWeeklyAnalysis);
    calculateWeightedBtn.addEventListener('click', handleCalculateWeightedCurve);
    saveCurveBtn.addEventListener('click', handleSaveCurve);
    saveForecastBtn.addEventListener('click', handleSaveForecastToDB);
});
</script>
{% endblock %}